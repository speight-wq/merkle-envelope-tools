<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; form-action 'none';">
  <title>Envelope Verifier — Merkle Envelope Tools</title>
  <script src="lib/crypto.js"></script>
  <script src="lib/encoding.js"></script>
  <script src="lib/headers.js"></script>
  <style>
    :root { --bg: #fff; --surface: #f8f9fa; --border: #dee2e6; --text: #212529; --text-2: #495057; --text-3: #868e96; --accent: #228be6; --success: #2f9e44; --success-bg: #d3f9d8; --warning: #e67700; --warning-bg: #fff3bf; --danger: #e03131; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; padding: 32px 24px; max-width: 720px; margin: 0 auto; }
    h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 8px; }
    .subtitle { color: var(--text-2); margin-bottom: 24px; }
    .subtitle a { color: var(--accent); text-decoration: none; }
    .section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; }
    .field { margin-bottom: 16px; }
    .label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-2); margin-bottom: 6px; }
    .input { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.875rem; }
    .input:focus { outline: none; border-color: var(--accent); }
    textarea.input { min-height: 150px; resize: vertical; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; }
    .btn-primary { background: var(--accent); color: white; }
    .hidden { display: none !important; }
    .divider { height: 1px; background: var(--border); margin: 16px 0; }
    .result-box { border-radius: 8px; padding: 20px; margin-top: 20px; }
    .result-box.valid { background: var(--success-bg); border: 2px solid var(--success); }
    .result-box.invalid { background: #ffe3e3; border: 2px solid var(--danger); }
    .result-title { font-weight: 600; margin-bottom: 12px; font-size: 1.1rem; }
    .result-box.valid .result-title { color: var(--success); }
    .result-box.invalid .result-title { color: var(--danger); }
    .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--text-3); }
    .info-value { font-family: monospace; font-size: 0.85rem; text-align: right; max-width: 60%; word-break: break-all; }
    .check-item { padding: 8px 0; display: flex; align-items: center; gap: 8px; }
    .check-pass { color: var(--success); }
    .check-fail { color: var(--danger); }
    .check-warn { color: var(--warning); }
    footer { text-align: center; color: var(--text-3); font-size: 0.8rem; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }
    footer a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <h1>Envelope Verifier</h1>
  <p class="subtitle">Verify Merkle envelopes offline. <a href="https://github.com/speight-wq/merkle-envelope-tools" target="_blank" rel="noopener">GitHub</a></p>

  <div class="section">
    <div class="section-title">Paste Envelope</div>
    <div class="field">
      <label class="label">Envelope JSON</label>
      <textarea class="input" id="envelope-input" placeholder='{"txid": "...", "rawTx": "...", "blockHeader": "...", "proof": [...]}'></textarea>
    </div>
    <button class="btn btn-primary" id="verify-btn">Verify Envelope</button>
  </div>

  <div id="result-section" class="hidden">
    <div id="result-box" class="result-box">
      <div class="result-title" id="result-title"></div>
      <div id="checks"></div>
      <div class="divider"></div>
      <div id="details"></div>
    </div>
  </div>

  <footer>
    <a href="generator.html">Generator</a> · Verifier · <a href="signer.html">Signer</a> · <a href="tests.html">Tests</a>
  </footer>

  <script>
  (function() {
    'use strict';

    document.getElementById('verify-btn').addEventListener('click', function() {
      const input = document.getElementById('envelope-input').value.trim();
      const resultSection = document.getElementById('result-section');
      const resultBox = document.getElementById('result-box');
      const resultTitle = document.getElementById('result-title');
      const checksDiv = document.getElementById('checks');
      const detailsDiv = document.getElementById('details');

      resultSection.classList.add('hidden');

      let envelope;
      try {
        envelope = JSON.parse(input);
        if (Array.isArray(envelope)) envelope = envelope[0];
      } catch (e) {
        showResult(false, 'Invalid JSON', [], []);
        return;
      }

      const checks = [];
      const details = [];
      let allPassed = true;

      // Check required fields
      if (!envelope.txid) {
        checks.push({ pass: false, text: 'Missing txid' });
        allPassed = false;
      } else {
        checks.push({ pass: true, text: 'TXID present' });
        details.push({ label: 'TXID', value: envelope.txid });
      }

      if (!envelope.rawTx) {
        checks.push({ pass: false, text: 'Missing rawTx' });
        allPassed = false;
      } else {
        checks.push({ pass: true, text: 'Raw transaction present' });
      }

      // Verify txid matches rawTx
      if (envelope.txid && envelope.rawTx) {
        try {
          const computed = reverseHex(bytesToHex(hash256(envelope.rawTx)));
          if (computed.toLowerCase() === envelope.txid.toLowerCase()) {
            checks.push({ pass: true, text: 'TXID matches rawTx hash' });
          } else {
            checks.push({ pass: false, text: 'TXID does not match rawTx' });
            allPassed = false;
          }
        } catch (e) {
          checks.push({ pass: false, text: 'Failed to hash rawTx: ' + e.message });
          allPassed = false;
        }
      }

      // Value
      const satoshis = envelope.satoshis || Math.round((envelope.value || 0) * 1e8);
      if (satoshis > 0) {
        details.push({ label: 'Value', value: (satoshis / 1e8).toFixed(8) + ' BSV' });
      }

      details.push({ label: 'Vout', value: (envelope.vout || 0).toString() });

      // Block header verification
      if (envelope.blockHeader) {
        try {
          if (envelope.blockHeader.length !== 160) {
            checks.push({ pass: false, text: 'Block header not 80 bytes' });
            allPassed = false;
          } else {
            const header = parseHeader(envelope.blockHeader);
            details.push({ label: 'Block Time', value: new Date(header.timestamp * 1000).toISOString() });
            
            // Verify PoW
            if (verifyPoW(envelope.blockHeader)) {
              checks.push({ pass: true, text: 'Proof-of-Work valid' });
              
              const blockHash = hashHeader(envelope.blockHeader);
              details.push({ label: 'Block Hash', value: blockHash.slice(0, 16) + '...' });
            } else {
              checks.push({ pass: false, text: 'Invalid Proof-of-Work' });
              allPassed = false;
            }
          }
        } catch (e) {
          checks.push({ pass: false, text: 'Header parse error: ' + e.message });
          allPassed = false;
        }
      } else {
        checks.push({ pass: null, text: 'No block header (unconfirmed?)' });
      }

      // Merkle proof verification
      if (envelope.proof && envelope.blockHeader && envelope.txid) {
        try {
          // Check for CVE-2012-2459
          if (!checkMerkleProofSafe(envelope.proof)) {
            checks.push({ pass: false, text: 'Merkle proof has duplicate hashes (CVE-2012-2459)' });
            allPassed = false;
          } else {
            const header = parseHeader(envelope.blockHeader);
            const valid = verifyMerkleProof(envelope.txid, envelope.proof, header.merkleRoot);
            
            if (valid) {
              checks.push({ pass: true, text: 'Merkle proof valid' });
            } else {
              checks.push({ pass: false, text: 'Merkle proof invalid' });
              allPassed = false;
            }
          }
        } catch (e) {
          checks.push({ pass: false, text: 'Merkle proof error: ' + e.message });
          allPassed = false;
        }
      } else if (envelope.blockHeader) {
        checks.push({ pass: null, text: 'No Merkle proof' });
      }

      // Confirmations
      if (typeof envelope.confirmations === 'number') {
        details.push({ label: 'Confirmations', value: envelope.confirmations.toString() });
        if (envelope.confirmations < 6) {
          checks.push({ pass: null, text: 'Low confirmations (' + envelope.confirmations + ')' });
        }
      }

      showResult(allPassed, allPassed ? 'VALID MERKLE PROOF' : 'VERIFICATION FAILED', checks, details);
    });

    function showResult(valid, title, checks, details) {
      const resultSection = document.getElementById('result-section');
      const resultBox = document.getElementById('result-box');
      const resultTitle = document.getElementById('result-title');
      const checksDiv = document.getElementById('checks');
      const detailsDiv = document.getElementById('details');

      resultBox.className = 'result-box ' + (valid ? 'valid' : 'invalid');
      resultTitle.textContent = (valid ? '✓ ' : '✗ ') + title;

      let checksHtml = '';
      for (const c of checks) {
        const icon = c.pass === true ? '✓' : (c.pass === false ? '✗' : '!');
        const cls = c.pass === true ? 'check-pass' : (c.pass === false ? 'check-fail' : 'check-warn');
        checksHtml += '<div class="check-item ' + cls + '">' + icon + ' ' + c.text + '</div>';
      }
      checksDiv.innerHTML = checksHtml;

      let detailsHtml = '';
      for (const d of details) {
        detailsHtml += '<div class="info-row"><span class="info-label">' + d.label + '</span><span class="info-value">' + d.value + '</span></div>';
      }
      detailsDiv.innerHTML = detailsHtml;

      resultSection.classList.remove('hidden');
    }

  })();
  </script>
</body>
</html>
